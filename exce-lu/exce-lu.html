<body>
<script type='text/javascript' src='./lib/zip.js'></script>
<script>

zip.workerScriptsPath = "./lib/";

function DP(in_data)
{
	if (!console) {
		return;
	}
	var _inspect = function(in_obj, in_indent) {
		for (var prop in in_obj) {
			var child = false;
			if ((typeof(in_obj[prop]) == 'object') && (in_obj[prop])) {
				child = true;
			}
			console.log(in_indent + prop + ' : ' + in_obj[prop]);
			if (child) {
				_inspect(in_obj[prop], in_indent + '  ');
			}
		}
	};
	_inspect({DP : in_data}, '');
}

function BIND(callback, self)
{
	return function() {
		callback.apply(self, arguments);
	}
}

var zipMgr = {
	reader : null,
	reading : 0,
	checker : null,
	callback : null,
	done : null,
	handleErr : function(in_err) {
		DP(in_err);
	},
	handleProgress : function(in_filename) {
		return function(in_cur, in_total) {
			DP(in_filename + ' : ' + in_cur + '(' + in_total + ')');
		};
	},
	handleClose : function() {
		DP('closed');
	},
	handleDone : function(in_filename) {
		return function(in_text) {
			(this.callback)(in_filename, in_text);
			var handleClose = BIND(this.handleClose, this);
			if (--this.reading > 0) {
				return;
			}
			this.reader.close(handleClose);
			(this.done)();
			this.reader = null;
			this.checker = null;
			this.callback = null;
			this.done = null;
		};
	},
	handleStart : function(in_reader) {
		this.reader = in_reader;
		var handleEntries = BIND(this.handleEntries, this);
		this.reader.getEntries(handleEntries);
	},
	handleEntries : function(in_entries) {
		if (in_entries.length > 0) {
			for (var i = 0; i < in_entries.length; i++) {
				var filename = in_entries[i].filename;
				if ((this.checker)(filename)) {
					this.reading++;
				} else {
					continue;
				}
				var handleDone = BIND(this.handleDone(filename), this);
				var handleProgress = BIND(this.handleProgress(filename), this);
				in_entries[i].getData(new zip.TextWriter(), handleDone, handleProgress);
			}
		}
	},
	parse : function(in_data, in_callback, in_checker, in_done) {
		this.callback = in_callback;
		this.checker = in_checker;
		this.done = in_done;
		var handleStart = BIND(this.handleStart, this);
		var handleErr = BIND(this.handleErr, this);
		zip.createReader(new zip.Data64URIReader(in_data), handleStart, handleErr);
	}
};

var xlsxObj = {
	docs : {}
};

function main(in_file)
{
	with (new FileReader()) {
		onload = function(e) {
			zipMgr.parse(e.target.result,
				function(in_filename, in_xml) {
					xlsxObj.docs[in_filename] = (new DOMParser()).parseFromString(in_xml, 'application/xml');
				},
				function(in_path) {
					if (in_path.match(/\.xml$/)) {
						return true;
					} else {
						return false;
					}
				},
				function() {
				}
			);
		}
		readAsDataURL(in_file);
	}
}

window.addEventListener('dragover', function(e) {
	e.preventDefault();
}, false);

window.addEventListener('drop', function(e) {
	main(e.dataTransfer.files[0]);
	e.preventDefault();
	e.stopPropagation();
}, false);

</script>
</body>
<style type='text/css'>
BODY {background-color: green;}
</style>
