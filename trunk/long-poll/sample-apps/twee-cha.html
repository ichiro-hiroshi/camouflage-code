<html>
<head>
<style>

TABLE { border-collapse: collapse;}
TD { padding: 0px;}
INPUT, TEXTAREA {
	border-top: solid 1px #999999;
	border-left: solid 1px #999999;
	border-right: solid 1px #dddddd;
	border-bottom: solid 1px #dddddd;
}
INPUT, BUTTON, TEXTAREA { margin-left: 5px;}

#MVIEW { width: 400px; height: 402px;}
#TWEET { width: 400px; height: 300px;}
#INPUT { width: 400px; height: 100px;}
#MVIEW, #INPUT, #TWEET {
	border-top: solid 1px #eeeeee;
	border-left: solid 1px #eeeeee;
	border-right: solid 1px #aaaaaa;
	border-bottom: solid 1px #aaaaaa;
	border-radius: 2px;
	background-color: #cccccc;
}

#MVIEW { display: none;}
#TWEET { width: 400px; height: 50px;}

.cV { display: block;}
.cH { display: none;}

</style>
</head>
<body>
<table>
<tr>
<td>
	<div id='MVIEW'></div>
</td>
<td>
	<table>
	<tr>
		<td><div id='TWEET'></div></td>
	</tr>
	<tr>
	<td>
		<div id='INPUT'>
			<div id='LOGIN' class='cV'><input id='NAME' /><br /><button onclick='login();'>LOGIN</button></div>
			<div id='WRITE' class='cH'><textarea id='POST'></textarea><br /><button onclick='post();'>POST</button><button onclick='logout();'>LOGOUT</button></div>
		</div>
	</td>
	</tr>
	</table>
</td>
</tr>
</table>
<script type='text/javascript' src='ConnJS.php'></script>
<script type='text/javascript'>

var gE = (function(){
	return (function(e){
		var hash = {};
		if (e.id) {
			hash[e.id] = e;
		}
		for (var i = 0; i < e.childNodes.length; i++) {
			var tmp = arguments.callee(e.childNodes.item(i));
			for (var id in tmp) {
				hash[id] = tmp[id];
			}
		}
		return hash;
	})(document.body);
})();

var gTLIST = {
	list : {
		/* ID : ELEMENT, ... */
	},
	update : function(in_obj) {
		for (var id in this.list) {
			if (in_obj.ID = id) {
				this.list[id].textContent = in_obj.DATA;
				return;
			}
		}
		var div = document.createElement('DIV');
		div.textContent = in_obj.DATA;
		gE.TWEET.appendChild(div);
		this.list[id] = div;
	}
};

var gSENT = '';
var CMD_LEN = 1;
var CMD_UDPATE = 'U';
var CMD_POSTED = 'P';

function send(in_cmd)
{
	if (ConnJS.send2(in_cmd + gSENT, cb_send)) {
//	if (ConnJS.send1(in_cmd + gSENT, cb_send)) {
		gSENT = gE.POST.value;
	}
}

function cb_send(in_err)
{
	if (in_err != APP_ERR_SUCCESS) {
		alert('send-error(' + in_err + ')');
	}
}

function cb_start(in_started)
{
	if (in_started) {
		window.addEventListener('keydown',
			function(e) {
				if (gSENT != gE.POST.value) {
					send(CMD_UDPATE);
				}
			}, false);
	} else {
		alert('start-error(' + in_started + ')');
	}
}

function cb_receive(in_err, in_data)
{
	if (in_err == APP_ERR_SUCCESS) {
		var reload = false;
		for (var i = 0; i < in_data.length; i++) {
			var obj = in_data[i];
			if (obj.DATA.substr(0, CMD_LEN) == CMD_POSTED) {
				// someone has posted.
				reload = true;
			}
			obj.DATA = obj.DATA.substr(CMD_LEN);
			gTLIST.update(obj);
		}
		if (reload) {
			reload();
		}
	} else {
		alert('receive-error(' + in_err + ')');
	}
}

function reload()
{
}

function post()
{
	// view ‚ÌXV‚ªŠ®—¹‚µ‚½‚çˆÈ‰º‚ðŽÀs
	gE.POST.value = '';
//	gSENT = '';
	send(CMD_POSTED);
}

function logout()
{
	gE.LOGIN.className = 'cV';
	gE.WRITE.className = 'cH';
	ConnJS.end();
}

function login()
{
	if (!gE.NAME.value) {
		alert('input name');
		return;
	}
	gE.LOGIN.className = 'cH';
	gE.WRITE.className = 'cV';
	ConnJS.start(gE.NAME.value, cb_start, cb_receive);
}

</script>
</body>
</html>
