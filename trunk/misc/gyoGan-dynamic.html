<script>

function DP(in_obj)
{
	return;
	console.log(in_obj);
}

var gWeight = {
	firstValue : 1,
	setting : [],
	configure : function(in_inc, in_cnt) {
		for (var i = 0; i < in_cnt; i++) {
			this.setting.push(this.firstValue + in_inc * i);
		}
	},
	get : function(in_level) {
		return this.setting[in_level];
	},
	cnt : function() {
		return this.setting.length;
	}
};

gWeight.configure(0.2, 10);

var gRatio = (function(in_cnt) {
	/*
		--				: 1/1				= 1
		-- + --			: 1/3 + 2/3			= 1
		-- + -- + --	: 1/7 + 2/7 + 4/7	= 1
	*/
	var cache = [null];
	for (var step = 1; step < in_cnt; step++) {
		cache[step] = {
			len : [],
			sumInc : [],
			sumDec : []
		}
		var denom = 0;
		for (var i = 0; i < step; i++) {
			cache[step].len[i] = gWeight.get(i);
			denom = denom + cache[step].len[i];
		}
		for (var i = 0; i < step; i++) {
			cache[step].len[i] /= denom;
		}
		for (var i = 0; i < step; i++) {
			cache[step].sumInc[i] = 0;
			cache[step].sumDec[i] = 0;
			for (var j = 0; j < (i + 1); j++) {
				cache[step].sumInc[i] += cache[step].len[j];
				cache[step].sumDec[i] += cache[step].len[(step - 1) - j];
			}
		}
	}
	return cache;
})(gWeight.cnt());

function cLineReduce(in_srcLen, in_dstLen, in_dstOrgS, in_dstOrgE)
{
	/*
		|----|----|====|----|----|
		^										: dstOrgB[0]
		     ^									: dstOrgB[1]
		          ^								: dstOrg.S
		               ^						: dstOrg.E
		                    ^					: dstOrgA[0]
		                         ^				: dstOrgA[1]
		|--------|-----|====|-----|--------|
		^										: srcOrgB[0]
		         ^								: srcOrgB[1]
		               ^						: srcOrg.S
		                    ^					: srcOrg.E
		                          ^				: srcOrgA[0]
	                                       ^	: srcOrgA[1]
	*/

	/* src */
	this.srcLen = in_srcLen;
	var orgLen = in_dstOrgE - in_dstOrgS;
	var dst2src = (in_srcLen - orgLen) / (in_dstLen - orgLen);
	this.srcOrg = {
		S : in_dstOrgS * dst2src,
		E : in_dstOrgS * dst2src + orgLen
	};
	this.srcOrgB = [];
	this.srcOrgA = [];
	/* dst */
	this.dstLen = in_dstLen;
	this.dstOrg = {
		S : in_dstOrgS,
		E : in_dstOrgE
	};
	this.dstOrgB = [];
	this.dstOrgA = [];
	/* OrgB (Before) */
	for (var step = 1; step < gRatio.length; step++) {
		var minSrc = this.srcOrg.S * gRatio[step].len[0];
		var minDst = this.dstOrg.S * (1 / step);
		DP('step : ' + step + ', (' + minSrc + ', ' + minDst + ')');
		if (minSrc < minDst) {
			DP('... break');
			break;
		}
		this.srcOrgB[0] = 0;
		this.dstOrgB[0] = 0;
		for (var i = 1; i < step; i++) {
			this.srcOrgB[i] = this.srcOrg.S * gRatio[step].sumDec[(i - 1)];
			this.dstOrgB[i] = this.dstOrg.S * (i / step);
		}
	}
	/* OrgA (After) */
	for (var step = 1; step < gRatio.length; step++) {
		var minSrc = (this.srcLen - this.srcOrg.E) * gRatio[step].len[0];
		var minDst = (this.dstLen - this.dstOrg.E) * (1 / step);
		DP('step : ' + step + ', (' + minSrc + ', ' + minDst + ')');
		if (minSrc < minDst) {
			DP('... break');
			break;
		}
		for (var i = 0; i < step; i++) {
			this.srcOrgA[i] = this.srcOrg.E + (this.srcLen - this.srcOrg.E) * gRatio[step].sumInc[i];
			this.dstOrgA[i] = this.dstOrg.E + (this.dstLen - this.dstOrg.E) * ((i + 1) / step);
		}
	}
}

cLineReduce.prototype = {
	srcPosArr : function() {
		return [].concat(this.srcOrgB, [this.srcOrg.S, this.srcOrg.E], this.srcOrgA);
	},
	dstPosArr : function() {
		return [].concat(this.dstOrgB, [this.dstOrg.S, this.dstOrg.E], this.dstOrgA);
	}
};

function test()
{
	var testData = {
		srcLen  : 600,
		dstLen  : 200,
		dstOrgS : 45,
		dstOrgE : 185
	};
	var line = new cLineReduce(
		testData.srcLen,
		testData.dstLen,
		testData.dstOrgS,
		testData.dstOrgE
	);
	DP(line);
	/* utility */
	var conf = {
		margin : 20,
		memory : 2
	};
	var drawLineUtil = (function(in_conf) {
		return function(in_ctx, in_color, in_lineCnt, in_start, in_len) {
			in_ctx.strokeStyle = in_color;
			in_ctx.beginPath();
			if (in_len > 0) {
				in_ctx.moveTo(in_conf.margin + in_start, in_conf.margin * in_lineCnt);
				in_ctx.lineTo(in_conf.margin + in_start + in_len, in_conf.margin * in_lineCnt);
			} else {
				in_ctx.moveTo(in_conf.margin + in_start, in_conf.margin * in_lineCnt - in_conf.memory);
				in_ctx.lineTo(in_conf.margin + in_start, in_conf.margin * in_lineCnt + in_conf.memory);
			}
			in_ctx.stroke();
		};
	})(conf);
	/* canvas */
	var canvas = document.createElement('CANVAS');
	canvas.width = testData.srcLen + conf.margin * 2;
	canvas.height = conf.margin * 3;
	document.write('<div></div>');
	document.getElementsByTagName('DIV').item(0).appendChild(canvas);
	ctx = canvas.getContext('2d');
	/* src */
	drawLineUtil(ctx, 'black', 1, 0, testData.srcLen);
	var arr = line.srcPosArr();
	for (var i = 0; i < arr.length; i++) {
		drawLineUtil(ctx, 'green', 1, arr[i], 0);
	}
	/* dst */
	drawLineUtil(ctx, 'black', 2, 0, testData.dstLen);
	var arr = line.dstPosArr();
	for (var i = 0; i < arr.length; i++) {
		drawLineUtil(ctx, 'green', 2, arr[i], 0);
	}
}

// test();

var dGyoGan = {
	windowMargin : 0.1,
	reduceMargin : {
		w : -1,
		h : -1
	},
	orgSize : 0.4,
	bind : function(prop) {
		var args = null;
		if (arguments.length > 1) {
			args = Array.prototype.slice.call(arguments);
			args.shift();
		}
		return (function(self, in_args) {
			if (in_args) {
				return function() {
					self[prop].apply(self, in_args);
				};
			} else {
				return function() {
					self[prop].call(self);
				};
			}
		})(this, args);
	},
	img : document.createElement('IMG'),
	canvas : document.createElement('CANVAS'),
	start : function(in_fname) {
		this.img.src = in_fname;
		this.img.addEventListener('load', this.bind('resetCanvas'), false);
		window.addEventListener('resize', this.bind('resetCanvas'), false);
		return this.canvas;
	},
	resetCanvas : function() {
		this.canvas.width = Math.min(window.innerWidth * (1 - this.windowMargin), this.img.width * 0.7);
		this.canvas.height = Math.min(window.innerHeight * (1 - this.windowMargin), this.img.height * 0.7);
		var reduce = (1 - this.orgSize) / 2;
		this.reduceMargin.w = reduce * this.canvas.width;
		this.reduceMargin.h = reduce * this.canvas.height;
		this.reDraw(0, 0);
	},
	reDraw : function(in_dx, in_dy) {
		if (Math.abs(in_dx) > this.reduceMargin.w) {
			return;
		}
		if (Math.abs(in_dy) > this.reduceMargin.h) {
			return;
		}
		var dx = in_dx + this.reduceMargin.w;
		var dy = in_dy + this.reduceMargin.h;
		/* width */
		var xLine = new cLineReduce(
			this.img.width,
			this.canvas.width,
			dx,
			dx + this.orgSize * this.canvas.width
		);
		/* height */
		var yLine = new cLineReduce(
			this.img.height,
			this.canvas.height,
			dy,
			dy + this.orgSize * this.canvas.height
		);
		ySrcPos = yLine.srcPosArr();
		xSrcPos = xLine.srcPosArr();
		yDstPos = yLine.dstPosArr();
		xDstPos = xLine.dstPosArr();
		var ctx = this.canvas.getContext('2d');
		for (var i = 0; i < ySrcPos.length - 1; i++) {
			for (var j = 0; j < xSrcPos.length - 1; j++) {
				/* src --> dst */
				ctx.drawImage(this.img,
					xSrcPos[j], ySrcPos[i], (xSrcPos[j + 1] - xSrcPos[j]), (ySrcPos[i + 1] - ySrcPos[i]),
					xDstPos[j], yDstPos[i], (xDstPos[j + 1] - xDstPos[j]), (yDstPos[i + 1] - yDstPos[i]));
			}
		}
	}
};

var gDrag = {
	evBind : function(prop) {
		return (function(self) {
			return function(in_event) {
				self[prop].call(self, in_event);
			};
		})(this);
	},
	hook : {
		func : null,
		fire : -1,
		wait : 50
	},
	start : function(in_elem, in_hook) {
		this.hook.func = in_hook;
		var events = ['mousemove', 'mouseout', 'mousedown', 'mouseup'];
		for (var i = 0; i < events.length; i++) {
			in_elem.addEventListener(events[i], this.evBind(events[i]), false);
		}
	},
	pos : {
		curr : {
			x : 0,
			y : 0
		},
		drag : null
	},
	mousemove : function(in_event) {
		if (this.pos.drag) {
			var dx = this.pos.curr.x + in_event.clientX - this.pos.drag.x;
			var dy = this.pos.curr.y + in_event.clientY - this.pos.drag.y;
			var now = (+new Date());
			if (now - this.hook.fire > this.hook.wait) {
				this.hook.fire = now;
				(this.hook.func)(dx, dy);
			}
		}
	},
	mouseout : function(in_event) {
		this.pos.curr.x = 0;
		this.pos.curr.y = 0;
		this.pos.drag = null;
		(this.hook.func)(0, 0);
	},
	mousedown : function(in_event) {
		if (!this.pos.drag) {
			this.pos.drag = {
				x : in_event.clientX,
				y : in_event.clientY
			};
		}
	},
	mouseup : function(in_event) {
		if (this.pos.drag) {
			this.pos.curr.x = in_event.clientX - this.pos.drag.x;
			this.pos.curr.y = in_event.clientY - this.pos.drag.y;
			this.pos.drag = null;
		}
	}
};

var elem = dGyoGan.start('45aki.jpg');

document.write('<ins></ins>');
document.getElementsByTagName('INS').item(0).appendChild(elem);

gDrag.start(elem, function(in_x, in_y) {
	dGyoGan.reDraw(in_x, in_y);
});

</script>

